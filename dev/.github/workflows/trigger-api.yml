name: Trigger API on Folder Change

on:
  push:
    branches:
      - main

jobs:
  send-api-calls:
    runs-on: ubuntu-latest
    env:
      DEV_API_URL: ${{ vars.DEV_API_URL }}
      PREPROD_API_URL: ${{ vars.PREPROD_API_URL }}
      PROD_API_URL: ${{ vars.PROD_API_URL }}
      API_TOKEN: ${{ secrets.TOKEN }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Get list of changed files
        id: changes
        run: |
          echo "CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)" >> $GITHUB_ENV

      - name: Send API POST requests for changed files
        run: |
          echo "$CHANGED_FILES"

          post_if_changed() {
            folder=$1
            url=$2
            file_path="$folder/features.json"

            if echo "$CHANGED_FILES" | grep -q "^$file_path$"; then
              echo "ðŸ“¤ Sending $file_path to $url"
              curl -X POST "$url" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $API_TOKEN" \
                --data-binary "@$file_path"
            else
              echo "âœ… No change in $file_path"
            fi
          }

          post_if_changed "dev" "$DEV_API_URL"
          post_if_changed "preprod" "$PREPROD_API_URL"
          post_if_changed "prod" "$PROD_API_URL"
